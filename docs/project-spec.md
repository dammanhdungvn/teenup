# üéØ Mini LMS ‚Äî Project Specification

## **üìã T·ªïng quan**

**Mini LMS (Learning Management System)** cho h·ªá th·ªëng qu·∫£n l√Ω h·ªçc t·∫≠p TeenUp Contest v·ªõi c√°c ch·ª©c nƒÉng ch√≠nh:

1. **Qu·∫£n l√Ω Parents/Students** - Qu·∫£n l√Ω th√¥ng tin ph·ª• huynh v√† h·ªçc sinh
2. **Qu·∫£n l√Ω Classes** - Qu·∫£n l√Ω l·ªõp h·ªçc v√† ƒëƒÉng k√Ω l·ªõp
3. **Qu·∫£n l√Ω Subscriptions** - Qu·∫£n l√Ω g√≥i h·ªçc v·ªõi s·ªë bu·ªïi v√† th·ªùi h·∫°n

## **üéØ M·ª•c ti√™u & ph·∫°m vi**

- ‚úÖ **T√≠nh ƒë√∫ng nghi·ªáp v·ª•** - Business logic ch√≠nh x√°c
- ‚úÖ **API RESTful r√µ r√†ng** - Chu·∫©n h√≥a endpoints
- ‚úÖ **Codebase s·∫°ch** - DTO-Mapper-Service-Repository pattern
- ‚úÖ **CI/CD Docker** - Containerization ho√†n ch·ªânh
- ‚úÖ **Frontend-Backend ƒë·ªìng b·ªô** - React + Spring Boot

---

## **üèóÔ∏è M√¥ h√¨nh d·ªØ li·ªáu (Domain Model)**

### **1.1 Entities (b·∫Øt bu·ªôc)**

| Entity | Fields | M√¥ t·∫£ |
|--------|--------|-------|
| **Parent** | `id, name, phone, email, createdAt, updatedAt` | Th√¥ng tin ph·ª• huynh |
| **Student** | `id, name, dob(LocalDate), gender(M/F/O), currentGrade, parent(FK), createdAt, updatedAt, version` | Th√¥ng tin h·ªçc sinh |
| **Class** | `id, name, subject, dayOfWeek(1..7), timeSlot("HH:mm-HH:mm"), teacherName, maxStudents, createdAt, updatedAt, version` | Th√¥ng tin l·ªõp h·ªçc |
| **ClassRegistration** | `class(FK), student(FK)` | ƒêƒÉng k√Ω l·ªõp h·ªçc (unique `(class_id, student_id)`) |
| **Subscription** | `id, student(FK), packageName, startDate, endDate, totalSessions, usedSessions, createdAt, updatedAt, version` | G√≥i h·ªçc |

### **1.2 R√†ng bu·ªôc & t√≠nh to√†n v·∫πn**

- **Student.belongsTo Parent** (b·∫Øt bu·ªôc)
- **ClassRegistration unique** per (class, student)
- **Class.maxStudents ‚â• 1**; kh√¥ng cho < s·ªë ƒëƒÉng k√Ω hi·ªán t·∫°i
- **Subscription**: `endDate >= startDate`, `totalSessions >= usedSessions`

---

## **üîå Chu·∫©n API & x·ª≠ l√Ω l·ªói**

### **2.1 Chu·∫©n chung**
- **JSON over HTTP**; base path `/api`
- **M·ªçi l·ªói chu·∫©n h√≥a** theo envelope:

```json
{
  "timestamp": "2024-12-14T10:30:00Z",
  "status": 409,
  "code": "SCHEDULE_CONFLICT",
  "message": "L·ªãch h·ªçc b·ªã tr√πng",
  "path": "/api/classes/123"
}
```

### **2.2 Error Codes**
S·ª≠ d·ª•ng `ErrorCode` ƒë√£ th·ªëng nh·∫•t:

| Code | HTTP Status | M√¥ t·∫£ |
|------|-------------|-------|
| `*_NOT_FOUND` | 404 | Resource kh√¥ng t·ªìn t·∫°i |
| `VALIDATION_FAILED` | 422 | D·ªØ li·ªáu kh√¥ng h·ª£p l·ªá |
| `INVALID_DAY` | 400 | Ng√†y kh√¥ng h·ª£p l·ªá |
| `ALREADY_REGISTERED` | 409 | ƒê√£ ƒëƒÉng k√Ω r·ªìi |
| `CLASS_FULL` | 409 | L·ªõp ƒë√£ ƒë·∫ßy |
| `SCHEDULE_CONFLICT` | 409 | L·ªãch h·ªçc b·ªã tr√πng |
| `CLASS_HAS_REGISTRATIONS` | 409 | L·ªõp c√≤n h·ªçc sinh ƒëƒÉng k√Ω |
| `CLASS_CAPACITY_TOO_SMALL` | 409 | S·ª©c ch·ª©a qu√° nh·ªè |
| `PARENT_HAS_STUDENTS` | 409 | Ph·ª• huynh c√≤n h·ªçc sinh |
| `STUDENT_HAS_REGISTRATIONS` | 409 | H·ªçc sinh c√≤n ƒëƒÉng k√Ω l·ªõp |
| `STUDENT_HAS_ACTIVE_SUBS` | 409 | H·ªçc sinh c√≤n g√≥i h·ªçc hi·ªáu l·ª±c |
| `SUBSCRIPTION_INACTIVE` | 409 | G√≥i h·ªçc kh√¥ng c√≤n hi·ªáu l·ª±c |
| `NO_REMAINING_SESSIONS` | 409 | H·∫øt bu·ªïi h·ªçc |
| `SUBSCRIPTION_IN_USE` | 409 | G√≥i h·ªçc ƒëang ƒë∆∞·ª£c s·ª≠ d·ª•ng |
| `SUBSCRIPTION_TOTAL_LT_USED` | 409 | T·ªïng bu·ªïi < ƒë√£ d√πng |
| `SUBSCRIPTION_INVALID_DATES` | 409 | Ng√†y kh√¥ng h·ª£p l·ªá |
| `SUBSCRIPTION_EXTEND_NO_PARAM` | 400 | Thi·∫øu tham s·ªë gia h·∫°n |
| `SAME_PARENT_TARGET` | 400 | C√πng ph·ª• huynh |
| `STUDENT_NOT_BELONG_TO_PARENT` | 400 | H·ªçc sinh kh√¥ng thu·ªôc ph·ª• huynh |
| `REGISTRATION_NOT_FOUND` | 404 | ƒêƒÉng k√Ω kh√¥ng t·ªìn t·∫°i |
| `SAME_CLASS_TARGET` | 400 | C√πng l·ªõp h·ªçc |

---

## **üéØ Y√™u c·∫ßu ch·ª©c nƒÉng (Functional Requirements)**

### **3.1 Parents Management**

#### **Use Cases:**
1. ‚úÖ **T·∫°o Parent** - `POST /api/parents`
2. ‚úÖ **Xem chi ti·∫øt Parent** - `GET /api/parents/{id}`
3. ‚úÖ **Danh s√°ch r√∫t g·ªçn** - `GET /api/parents/list`
4. ‚úÖ **C·∫≠p nh·∫≠t Parent** - `PATCH /api/parents/{id}`
5. ‚úÖ **Xo√° Parent** - `DELETE /api/parents/{id}`
6. ‚úÖ **Reassign Students** - `PATCH /api/parents/{sourceId}/reassign`

#### **Business Rules:**
- **Xo√°**: n·∫øu c√≤n `Students` ‚Üí `409 PARENT_HAS_STUDENTS`
- **Reassign**: `targetParentId != sourceParentId` (`SAME_PARENT_TARGET`)
- **Validation**: n·∫øu ch·ªâ ƒë·ªãnh `studentIds`, t·∫•t c·∫£ ph·∫£i thu·ªôc source (`STUDENT_NOT_BELONG_TO_PARENT`)

#### **Implementation:**
- **DTO**: `UpdateParentRequest { name?, phone?, email? }`
- **DTO**: `ReassignStudentsRequest { targetParentId, studentIds? }`
- **Response**: `ReassignResultResponse { sourceParentId, targetParentId, movedCount, remainingAtSource }`
- **Mapper**: `ParentMapper.updateEntityFromDto()` (MapStruct, IGNORE null)
- **Repo**: `StudentsRepository.countByParentId()`, `findIdsNotBelongToParent()`, `reassignAll()/reassignSome()`

---

### **3.2 Students Management**

#### **Use Cases:**
1. ‚úÖ **T·∫°o Student** - `POST /api/students`
2. ‚úÖ **Xem chi ti·∫øt Student** - `GET /api/students/{id}`
3. ‚úÖ **Danh s√°ch r√∫t g·ªçn** - `GET /api/students/list`
4. ‚úÖ **C·∫≠p nh·∫≠t Student** - `PATCH /api/students/{id}`
5. ‚úÖ **Xo√° Student** - `DELETE /api/students/{id}`

#### **Business Rules:**
- **Validation**: `dob` l√† qu√° kh·ª©; `gender ‚àà {M,F,O}`
- **Xo√°**: 
  - Kh√¥ng c√≥ ƒëƒÉng k√Ω l·ªõp (`STUDENT_HAS_REGISTRATIONS`)
  - Kh√¥ng c√≥ g√≥i c√≤n hi·ªáu l·ª±c ho·∫∑c c√≤n bu·ªïi (`STUDENT_HAS_ACTIVE_SUBS`)

#### **Implementation:**
- **DTO**: `CreateStudentRequest`, `UpdateStudentRequest { name?, dob?, gender?, currentGrade?, parentId? }`
- **Mapper**: `StudentMapper` (toEntity, toResponse, updateEntityFromDto IGNORE null)
- **Repo**: `ClassRegistrationsRepository.countByStudentId(studentId)`, `SubscriptionsRepository.existsActiveByStudent(studentId)`

---

### **3.3 Classes Management**

#### **Use Cases:**
1. ‚úÖ **T·∫°o Class** - `POST /api/classes`
2. ‚úÖ **Danh s√°ch Class** - `GET /api/classes[?day=1..7][&expand=registrations]`
3. ‚úÖ **Chi ti·∫øt Class** - `GET /api/classes/{id}`
4. ‚úÖ **C·∫≠p nh·∫≠t Class** - `PATCH /api/classes/{id}`
5. ‚úÖ **Xo√° Class** - `DELETE /api/classes/{id}`

#### **Business Rules:**
- **Validation**: `dayOfWeek ‚àà [1..7]`, `timeSlot` chu·∫©n `HH:mm-HH:mm`
- **C·∫≠p nh·∫≠t**:
  - Gi·∫£m `maxStudents` kh√¥ng ƒë∆∞·ª£c < s·ªë ƒëƒÉng k√Ω hi·ªán t·∫°i (`CLASS_CAPACITY_TOO_SMALL`)
  - ƒê·ªïi `dayOfWeek`/`timeSlot` kh√¥ng ƒë∆∞·ª£c g√¢y tr√πng l·ªãch (`SCHEDULE_CONFLICT`)
- **Xo√°**: n·∫øu c√≤n registrations ‚Üí `CLASS_HAS_REGISTRATIONS`

#### **Implementation:**
- **DTO**: `CreateClassRequest`, `UpdateClassRequest { name?, subject?, dayOfWeek?, timeSlot?, teacherName?, maxStudents? }`
- **Mapper**: `ClassMapper.updateEntityFromDto()` (IGNORE null)
- **Repo**: `ClassRegistrationsRepository.countByClassId(classId)`, `existsConflictWhenReschedule(classId, dayOfWeek, start, end)`

---

### **3.4 Class Registrations Management**

#### **Use Cases:**
1. ‚úÖ **ƒêƒÉng k√Ω Student v√†o Class** - `POST /api/classes/{classId}/register`
2. ‚úÖ **Xem danh s√°ch h·ªçc sinh c·ªßa Class** - `GET /api/classes/{classId}/registrations`
3. ‚úÖ **Xem danh s√°ch l·ªõp c·ªßa Student** - `GET /api/students/{studentId}/classes`
4. ‚úÖ **Hu·ª∑ ƒëƒÉng k√Ω kh·ªèi Class** - `DELETE /api/classes/{classId}/registrations/{studentId}`
5. ‚úÖ **Chuy·ªÉn l·ªõp** - `PATCH /api/classes/{classId}/registrations/{studentId}`

#### **Business Rules:**
- **Register**:
  - Kh√¥ng tr√πng (ƒë√£ ƒëƒÉng k√Ω) ‚Üí `ALREADY_REGISTERED`
  - Kh√¥ng v∆∞·ª£t `maxStudents` ‚Üí `CLASS_FULL`
  - Kh√¥ng tr√πng l·ªãch v·ªõi classes kh√°c c·ªßa student ‚Üí `SCHEDULE_CONFLICT`
- **Unregister**: b·∫£n ghi ph·∫£i t·ªìn t·∫°i (`REGISTRATION_NOT_FOUND`)
- **Move**: validate ƒë·∫ßy ƒë·ªß c√°c r√†ng bu·ªôc

---

### **3.5 Subscriptions Management**

#### **Use Cases:**
1. ‚úÖ **T·∫°o g√≥i h·ªçc** - `POST /api/subscriptions`
2. ‚úÖ **Xem chi ti·∫øt g√≥i** - `GET /api/subscriptions/{id}`
3. ‚úÖ **Danh s√°ch g√≥i** - `GET /api/subscriptions[?studentId=]`
4. ‚úÖ **D√πng 1 bu·ªïi** - `PATCH /api/subscriptions/{id}/use`
5. ‚úÖ **C·∫≠p nh·∫≠t g√≥i** - `PATCH /api/subscriptions/{id}`
6. ‚úÖ **Xo√° g√≥i** - `DELETE /api/subscriptions/{id}`
7. ‚úÖ **Admin: Reset used** - `PATCH /api/subscriptions/{id}/reset-used`
8. ‚úÖ **Admin: Extend** - `PATCH /api/subscriptions/{id}/extend`

#### **Business Rules:**
- **T·∫°o**: `endDate >= startDate`
- **Use**: ng√†y hi·ªán t·∫°i n·∫±m trong `[startDate, endDate]` v√† `usedSessions < totalSessions`
- **Update**: `totalSessions` m·ªõi kh√¥ng ƒë∆∞·ª£c `< usedSessions`
- **Delete**: `usedSessions == 0` m·ªõi ƒë∆∞·ª£c xo√°
- **Extend**: ph·∫£i c√≥ `addSessions` v√†/ho·∫∑c `endDate` h·ª£p l·ªá

---

## **‚öôÔ∏è Thi·∫øt k·∫ø k·ªπ thu·∫≠t (Technical Design)**

### **4.1 Ki·∫øn tr√∫c & conventions**

#### **Layers:**
```
Controller ‚Üí Service (transactional) ‚Üí Repository (Spring Data JPA)
```

#### **DTO/Mapper:**
- **Input/Output DTO** t√°ch entity
- **MapStruct** v·ªõi `NullValuePropertyMappingStrategy.IGNORE` cho PATCH
- **Validation**: `jakarta.validation` tr√™n DTO + ki·ªÉm tra nghi·ªáp v·ª• ·ªü Service

#### **Transactions:**
- **Read**: `@Transactional(readOnly=true)`
- **Write**: `@Transactional` (m·∫∑c ƒë·ªãnh)
- **Optimistic locking**: Entity c√≥ `@Version`

#### **Date/Time:**
- **LocalDate** cho ng√†y
- **Instant** cho audit
- **Asia/Bangkok** TZ runtime

### **4.2 Ki·ªÉm tra tr√πng l·ªãch (Schedule Conflict)**

#### **Logic overlap:**
```
timeSlot: "HH:mm-HH:mm"
Overlap n·∫øu: aStart < bEnd && bStart < aEnd
```

#### **Ki·ªÉm tra conflict:**
- **Khi ƒëƒÉng k√Ω/move**: check conflict v·ªõi t·∫•t c·∫£ l·ªõp c·ªßa h·ªçc sinh
- **Khi PATCH Class ƒë·ªïi l·ªãch**: native query ki·ªÉm tra conflict gi·ªØa l·ªãch m·ªõi v√† c√°c l·ªõp kh√°c c·ªßa m·ªçi h·ªçc sinh ƒëang h·ªçc l·ªõp n√†y

### **4.3 Truy v·∫•n hi·ªáu nƒÉng**

- **JPQL/native** thay v√¨ load list v√† filter tr√™n Java
- **Fetch join** khi c·∫ßn m·ªü r·ªông (`expand=registrations`) ƒë·ªÉ tr√°nh N+1
- **Optimized queries** cho c√°c business checks

---

## **üê≥ DevOps & m√¥i tr∆∞·ªùng**

### **5.1 Docker Setup**

#### **Backend Dockerfile:**
- **Multi-stage Maven build** (3.8.7, Temurin 21)
- **Runtime JRE 21**
- **SPRING_PROFILES_ACTIVE=dev**
- **EXPOSE 8081**

#### **Docker Compose:**
```yaml
services:
  db: mysql:8 (3306)
  backend: Spring Boot (8081)
  frontend: React/Nginx (3000)
```

#### **Environment:**
- **DB URL**: `jdbc:mysql://db:3306/teenup?...`
- **Healthcheck** MySQL
- **depends_on** backend‚Üídb(healthy)

### **5.2 Data Seeding (profile `dev`)**

- **2 parents** m·∫´u
- **3 students** m·∫´u  
- **2‚Äì3 classes** m·∫´u
- **Registrations/subscriptions** m·∫´u

---

## **üß™ Testing & Acceptance**

### **6.1 Unit/Integration Tests**

#### **Service-level tests:**
- ‚úÖ **Register/Move/Unregister** (ƒë·ªß case FULL/ALREADY/CONFLICT)
- ‚úÖ **Delete student** (blocked by regs/subs)
- ‚úÖ **Patch class** (capacity & conflict)
- ‚úÖ **Subscriptions** (use/inactive/no remaining/update/extend/reset/delete)

### **6.2 API Testing**

- **cURL scripts** cho t·∫•t c·∫£ endpoints
- **Postman Collection** b√°m s√°t API spec
- **Error scenarios** testing

### **6.3 Acceptance Testing (E2E)**

#### **Test scenarios:**
1. **T·∫°o student** ‚Üí xem detail (k√®m parent)
2. **T·∫°o class** ‚Üí weekly view FE hi·ªÉn th·ªã ƒë√∫ng
3. **ƒêƒÉng k√Ω** ‚Üí xem h·ªçc sinh c·ªßa class; move; unregister
4. **Kh·ªüi t·∫°o g√≥i** ‚Üí use ‚Üí extend ‚Üí reset ‚Üí delete

---

## **üåê Frontend Integration**

### **7.1 Component Mapping**

| Feature | Components | API Integration |
|---------|------------|-----------------|
| **Parents** | Form create, detail, dropdown list, reassign modal | `parents.api.js` |
| **Students** | Form create, detail, delete/update | `students.api.js` |
| **Classes** | Weekly grid, class detail, CRUD operations | `classes.api.js` |
| **Subscriptions** | Create/detail/list, use, patch, delete | `subscriptions.api.js` |

### **7.2 Technical Stack**

- **API Client**: Axios instance + interceptors map `ApiError`
- **Form Validation**: Mirror backend validation rules
- **State Management**: React Query cache danh s√°ch l·ªõp, dropdowns
- **UI Library**: Ant Design components

---

## **üìö T√†i li·ªáu li√™n quan**

### **Backend Documentation:**
- üìã **[API Endpoints](backend/contest/docs/api-endpoints.md)** - H·ª£p ƒë·ªìng API + v√≠ d·ª• success & error
- üèóÔ∏è **[Architecture](backend/contest/docs/ARCHITECTURE.md)** - Ki·∫øn tr√∫c h·ªá th·ªëng
- üéØ **[Business Logic](backend/contest/docs/BUSINESS-LOGIC.md)** - Business rules chi ti·∫øt
- üíª **[Development Guide](backend/contest/docs/DEVELOPMENT.md)** - H∆∞·ªõng d·∫´n ph√°t tri·ªÉn

### **Frontend Documentation:**
- üåê **[Frontend Index](frontend/docs/INDEX.md)** - T·∫•t c·∫£ frontend docs
- üîå **[API Integration](frontend/docs/API-INTEGRATION.md)** - K·∫øt n·ªëi backend
- üèóÔ∏è **[Project Structure](frontend/docs/STRUCTURE.md)** - C·∫•u tr√∫c frontend
- üê≥ **[Docker Guide](frontend/docs/DOCKER.md)** - Containerization

### **System Documentation:**
- üê≥ **[Docker Setup](docker-compose.yml)** - C·∫•u h√¨nh Docker
- üìñ **[Main README](README.md)** - T·ªïng quan to√†n b·ªô h·ªá th·ªëng

---

## **üîÑ Quy tr√¨nh c·∫≠p nh·∫≠t**

### **Khi thay ƒë·ªïi model:**
1. **Entity** + **Repository queries** + **Business rules** + **Documentation**
2. **API endpoints** + **DTOs** + **Validation**
3. **Frontend components** + **API integration**

### **Khi m·ªü r·ªông t√¨m ki·∫øm/l·ªçc/ph√¢n trang:**
- Th√™m `GET /list` phi√™n b·∫£n c√≥ `page,size,sort,q`
- C·∫≠p nh·∫≠t frontend filters v√† pagination

---

## **üìã Data Contracts (JSON Schema)**

### **Parent DTOs:**
```json
// CreateParentRequest
{
  "name": "string (required)",
  "phone": "string (required)",
  "email": "string (required, email format)"
}

// UpdateParentRequest  
{
  "name": "string (optional)",
  "phone": "string (optional)",
  "email": "string (optional, email format)"
}

// ReassignStudentsRequest
{
  "targetParentId": "long (required)",
  "studentIds": "array of long (optional)"
}
```

### **Student DTOs:**
```json
// CreateStudentRequest
{
  "name": "string (required)",
  "dob": "LocalDate (required, past date)",
  "gender": "enum (M/F/O) (required)",
  "currentGrade": "string (required)",
  "parentId": "long (required)"
}

// UpdateStudentRequest
{
  "name": "string (optional)",
  "dob": "LocalDate (optional, past date)",
  "gender": "enum (M/F/O) (optional)",
  "currentGrade": "string (optional)",
  "parentId": "long (optional)"
}
```

### **Class DTOs:**
```json
// CreateClassRequest
{
  "name": "string (required)",
  "subject": "string (required)",
  "dayOfWeek": "integer (1-7) (required)",
  "timeSlot": "string (HH:mm-HH:mm) (required)",
  "teacherName": "string (required)",
  "maxStudents": "integer (>=1) (required)"
}

// UpdateClassRequest
{
  "name": "string (optional)",
  "subject": "string (optional)",
  "dayOfWeek": "integer (1-7) (optional)",
  "timeSlot": "string (HH:mm-HH:mm) (optional)",
  "teacherName": "string (optional)",
  "maxStudents": "integer (>=1) (optional)"
}
```

### **Subscription DTOs:**
```json
// CreateSubscriptionRequest
{
  "studentId": "long (required)",
  "packageName": "string (required)",
  "startDate": "LocalDate (required)",
  "endDate": "LocalDate (required, >= startDate)",
  "totalSessions": "integer (>=1) (required)"
}

// ExtendSubscriptionRequest
{
  "addSessions": "integer (>=1) (optional)",
  "endDate": "LocalDate (optional, >= current endDate)"
}
```

---

## **üéØ K·∫øt lu·∫≠n**

T√†i li·ªáu n√†y cung c·∫•p **ƒë·∫∑c t·∫£ chi ti·∫øt** (functional + technical) ƒë·ªß ƒë·ªÉ development team d·ª±a v√†o v√† implement. T·∫•t c·∫£ c√°c ch·ª©c nƒÉng ƒë√£ ƒë∆∞·ª£c **implement ho√†n ch·ªânh** v√† **tested** theo y√™u c·∫ßu.

### **Tr·∫°ng th√°i hi·ªán t·∫°i:**
- ‚úÖ **Backend**: Ho√†n th√†nh 100% theo spec
- ‚úÖ **Frontend**: Ho√†n th√†nh 100% theo spec  
- ‚úÖ **Docker**: Setup ho√†n ch·ªânh
- ‚úÖ **Documentation**: ƒê·∫ßy ƒë·ªß v√† ƒë·ªìng b·ªô

### **Next Steps:**
1. **Review** t√†i li·ªáu n√†y v·ªõi team
2. **Validate** business requirements
3. **Plan** testing strategy
4. **Deploy** to staging/production

---

**üìÖ Last Updated:** December 2024  
**üîÑ Version:** 1.0.0  
**üë• Maintainer:** Development Team  
**üìß Contact:** [your.email@company.com]
